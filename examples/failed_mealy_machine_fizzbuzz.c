#include <stdio.h>
#include <string.h>
#include <assert.h>

#include "stately.h"

enum input { INVALID, ZERO_CHAR, ONE_CHAR };

enum state {
    TRAP,
    START,
    RESET,
    _1,
    _2,
    _3, FIZZ,
    _4,
    _5, BUZZ,
    _6,
    _7,
    _8,
    _9,
    _10,
    _11,
    _12,
    _13,
    _14,
    _15, FIZZBUZZ,
};

const char char_map[128] = {
    ['0'] = ZERO_CHAR,
    ['1'] = ONE_CHAR,
};

int map_chr(const void *chr) {
    return char_map[(int)*(const char *)chr];
}

int main(void)
{
   /** Attempted (but failed) Mealy machine that
    ** tries to FizzBuzz, but fails horribly.
    ** It counts numbers as unary "1"s separated
    ** by 0s. It prints out the number every time
    ** (whereas in true FizzBuzz it's only supposed
    ** to print the number out when it's not divisible
    ** by 3, 5, or 15.
    **/

    struct state_machine machine = {
       
        // Start state
        .curr_state = START,

        // Input mapper
        .map = map_chr,

        // States
        .state_table = {

            [START] = {
                [ONE_CHAR] = _1,
            },

            [RESET] = {
                [ONE_CHAR] = _1,
            },

            [_1] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR]  = _2,
            },

            [_2] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _3,
            },

            [_3] = {
                [ZERO_CHAR] = FIZZ,
                [ONE_CHAR] = _4,
            },

            [_4] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _5,
            },

            [_5] = {
                [ZERO_CHAR] = BUZZ,
                [ONE_CHAR] = _6,
            },

            [_6] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _7,
            },

            [_7] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _8,
            },

            [_8] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _9,
            },

            [_9] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _10,
            },

            [_10] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _11,
            },

            [_11] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _12,
            },

            [_12] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _13,
            },

            [_13] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _14,
            },

            [_14] = {
                [ZERO_CHAR] = RESET,
                [ONE_CHAR] = _15,
            },

            [_15] = {
                [ZERO_CHAR] = FIZZBUZZ,
                [ONE_CHAR] = _1,
            },

            [FIZZ] = {
                [ONE_CHAR] = _1,
            },

            [BUZZ] = {
                [ONE_CHAR] = _1,
            },

            [FIZZBUZZ] = {
                [ONE_CHAR] = _1
            },

        }

    };

    struct test_case {
        char input[5153];
        int expected_result;
    };

    struct test_case tests[] = {
        { "10110111011110111110111111011111110111111110111111111011111111110111111111110111111111111011111111111110111111111111110111111111111111011111111111111110111111111111111110111111111111111111011111111111111111110111111111111111111110111111111111111111111011111111111111111111110111111111111111111111110111111111111111111111111011111111111111111111111110111111111111111111111111110111111111111111111111111111011111111111111111111111111110111111111111111111111111111110111111111111111111111111111111011111111111111111111111111111110111111111111111111111111111111110111111111111111111111111111111111011111111111111111111111111111111110111111111111111111111111111111111110111111111111111111111111111111111111011111111111111111111111111111111111110111111111111111111111111111111111111110111111111111111111111111111111111111111011111111111111111111111111111111111111110111111111111111111111111111111111111111110111111111111111111111111111111111111111111011111111111111111111111111111111111111111110111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110", RESET },
    };

    for (int i = 0; i < (int)(sizeof(tests) / sizeof(*tests)); i++) {
        printf("Testing case '%s'\n", tests[i].input);
        SET_STATE(machine, START);
        int state = GET_STATE(machine);
        for (int c = 0; tests[i].input[c]; c++) {
            state = GET_NEXT_STATE(machine, &tests[i].input[c]);
            if (state == FIZZ) puts("Fizz");
            else if (state == BUZZ) puts("Buzz");
            else if (state == FIZZBUZZ) puts("FizzBuzz");
            else if (state == RESET) printf("\n");
            else printf("1");
        }
        if (GET_STATE(machine) != tests[i].expected_result) {
            printf("Expected %d but got %d\n", tests[i].expected_result, GET_STATE(machine));
        }
        puts("");
    }

    puts("Complete");

    return 0;
}
